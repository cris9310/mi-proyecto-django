{% extends "Base2.html" %} 
{% load static %} 
{% block title %}Pagos | Portal CNE{% endblock title %}
{% block extracontent %}

<div class="container-fluid">
  <div class="row" style=" padding-left: 15px" >
    <h1 class="h3" id="tit"> <i class="fa-solid fa-circle-dollar-to-slot"></i> Historial de pagos</h1>
  </div>
</div>

<div class="container-fluid">
  {% for j in datos %}
  <div id="submenu" style=" height:120px; width:100%; padding: 15px; display: flex">
    <div >
      <div style="display: flex" ><h1 class="h5" id="tit">Nombre del estudiante:</h1><h5>&nbsp;{{j.apellidos}} {{j.nombre}}</h5></div>
      <div style="display: flex" ><h1 class="h5" id="tit">Código:</h1><h5>&nbsp;{{j.codigo}}</h5></div>
      <div style="display: flex" ><h1 class="h5" id="tit">Programa:</h1><h5>&nbsp;{{j.carrera.programa_name}}</h5></div> 
    </div>
    </div>
    
  </div>
  {% endfor %}
</div>
<div class="container-fluid" style="">
  <div  class="row" >
    <div id="conte" style="height:auto; width: 100%; background: #FFFFFF; ">
      <div class="col" id="anadir">
        <div class="row" >
          <h1 class="h5" id="tit"> Progreso financiero del estudiante:</h1>
        </div>
        <div class="row">
          <div style="display:flex" >
            <div class="progress" >
              <div id="uno" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="{{progreso}}" aria-valuemin="0" aria-valuemax="100" style="width: {{progreso}}%">
              </div>
            </div>
            <div>
              &nbsp;
            </div>
            <div>
              <h1 class="h5" id="tit"> {{progreso}} % </h1>
            </div>
          </div >
        </div>
      </div>
      <div class="linea"></div>
      <div class ="tabla" style=" " >
        {% if datos %} 
          <table id="table_id7"  class="hover" style="width:100%; ">
            <thead>
              <th>Detalle </th>
              <th>Código </th>
              <th>Descripción</th>
              <th>Estado</th>
              <th>Monto</th>
              <th>Pagado</th>
              <th>Acción</th>
            </thead>
            <tbody>
              {% for i in invoice  %}
              <tr>
                {% if i.pagado != "$ 0.00" %}
                <td class='dt-control' defaultContent="" orderable='false' data= "null" >
                  <input type="hidden" name="funt" id="funt" class="funt" value="{{i.pk}}">
                </td>
                {% else %}
                <td ><span id="inactivo"><i class="fa-solid fa-circle-xmark"></i></span></td></td>
                {% endif %}
                <td >{{i.codigo}}</td>
                <td >{{i.descripcion}}</td>
                <td >
                  {% if i.estado.estado == "Pagada"  %}
                  <span id="activo" style="width:100%"><i class="fa-regular fa-circle-check"></i> &nbsp; {{i.estado.estado}} </span>
                  {% elif i.estado.estado == "Abono" %}
                  <span id="cursando"><i class="fa-solid fa-money-bill-wave"></i> &nbsp; {{i.estado.estado}} </span>
                  {% else %}
                  <span id="inactivo"><i class="fa-solid fa-circle-xmark"></i> &nbsp; {{i.estado.estado}} </span>
                  {% endif %}
                </td>
                <td >{{i.monto}}</td>
                <td >{{i.pagado}}</td>
                {% if i.pagado == i.monto %}
                <td>
                  <a ><i id="iconos" class="fa-solid fa-check"></i></a>
                </td>
                {% else %}
                <td >
                  <a onclick="abrir_modal_general3('{% url 'finance_app:finance-list-invoice-detail-up' i.pk %}')" title="Editar"><i id="iconos" class="fa-regular fa-pen-to-square"></i></a>
                </td>
                {% endif %}
              </tr>
            {% endfor %}
            </tbody>
          </table> 
        {% else %}
        <table id="table_id4"  class="hover" style="width:100%; ">
          <thead >
            <th>Detalle </th>
            <th>Código </th>
            <th>Descripción</th>
            <th>Estado</th>
            <th>Monto</th>
            <th>Pagado</th>
            <th>Acción</th>
          </thead>
          <tbody>
            <tr>
              <td > - </td >
              <td > - </td >
              <td > - </td >
              <td > - </td >
              <td > - </td >
              <td > - </td >
              <td > - </td >
            </tr>
          </tbody>
        </table>   
        {% endif %}
      </div>
    </div>
  </div>
  </div>
</div>



<div class="modal fade" id="edicion" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true"></div>


    
{% endblock extracontent %}


{% block js %}

<script>
$(document).ready(function () {

  var $ = jQuery.noConflict();
  var tabla = $('#table_id7').DataTable({

    language: {
      "decimal": "",
      "emptyTable": "No hay información",
      "info": "Mostrando _START_ a _END_ de _TOTAL_ Registros",
      "infoEmpty": "Mostrando 0 to 0 of 0 Registros",
      "infoFiltered": "(Filtrado de _MAX_ total entradas)",
      "infoPostFix": "",
      "thousands": ",",
      "lengthMenu": "Items por rango: _MENU_",
      "loadingRecords": "Cargando...",
      "processing": "Procesando...",
      "search": "Buscar:",
      "zeroRecords": "Sin resultados encontrados",
      "paginate": {
        "first": "Primero",
        "last": "Ultimo",
        "next": "Siguiente",
        "previous": "Anterior"
      }
    },
    "columns": [
      { "width": "3%", "className": 'dt-body-center' },
      null,
      null,
      null,
      null,
      null,
      { "width": "3%", "className": 'dt-body-center' },
    ],

  });


  function format(d) {
    // `d` is the original data object for the row
    const f= d.map(function(dat){
      var id = String(dat.pk) + "/'"
      var link="'/finance/finance-list-invoice/detail-sub/" + id;
      var eliminar="'/finance/finance-list-invoice/delete-sub/" + id;
      return (
        
        '<tbody>' +
        '<td>' + dat.consecutivo+'</td>' + '<td>'+ dat.payed +'</td>' +'<td>' + dat.fecha+'</td>' +'<td><a onclick="abrir_modal_general3('+
           link
          +')" title="Editar"><i id="iconos" class="fa-regular fa-eye"></i></a>   <a onclick="abrir_modal_general3('+
          eliminar
         +')" title="Eliminar"><i id="iconos" class="fa-solid fa-trash-can"></i></a> </td>' + 
        '</tbody>'   
      );
    });
    return (
        '<table cellpadding="5" cellspacing="0" class="hover" border="0" style="padding-left:50px;">'+
        '<thead style="color:grey">'+
        '<th>Consecutivo</th>'+ '<th>Valor pagado</th>'+ '<th>Fecha de pago</th>'+'<th>Consulta</th>'+
        '</thead>'+
        f
        +'</table>'
        
         
    );
  }

  
  
 
  tabla.on('click', 'td.dt-control', function () {
    var tr = $(this).closest('tr');
    var row = tabla.row(tr);
    var valor = tr.find('input[name=funt]').val();
    if (row.child.isShown()) {
        // This row is already open - close it
        row.child.hide();
        tr.removeClass('shown');
    } else {
        // Open this row
      var request = $.ajax({
        type: "GET",
        url: "{% url 'finance_app:finance-invoice-detail-more' %}",
        data: {
            "info": valor,
        },
        
      });
      request.done(function(response) {
        const infor = response.data.map(function(d) {
          return d;
        
      });
      row.child(format(infor)).show();
      tr.addClass('shown');
      });
      
    }
  });


});


function abrir_modal_general3(url) {
  $("#edicion").load(url, function () {
    $(this).modal("show");
  });
}



</script>



{% endblock js %}
